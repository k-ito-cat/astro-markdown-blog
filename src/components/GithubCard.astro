---
import { Icon } from "astro-icon/components";

type Props = {
  url: string;
};
const { url } = Astro.props;

function extractRepoApiUrl(url: string): string {
  const match = url.match(/^https:\/\/github\.com\/([^/]+)\/([^/]+)/);
  if (!match) throw new Error("GitHubのURLではありません");
  const [, owner, repo] = match;
  return `https://api.github.com/repos/${owner}/${repo}`;
}
const apiUrl = extractRepoApiUrl(url);
const res = await fetch(apiUrl, {
  headers: {
    Authorization: `Bearer ${import.meta.env.VITE_GITHUB_TOKEN}`,
  },
});

if (!res.ok) {
  throw new Error(String(res.status));
}

const repoInfo = await res.json();

const stars =
  typeof repoInfo.stargazers_count === "number"
    ? repoInfo.stargazers_count
    : null;
const language =
  typeof repoInfo.language === "string" ? repoInfo.language : null;

function formatCompactNumber(n: number): string {
  return new Intl.NumberFormat("en", { notation: "compact" }).format(n);
}
---

<a
  href={url}
  target="_blank"
  rel="noopener noreferrer"
  class="group my-4 flex min-w-0 items-start gap-2 no-underline"
  aria-label={`Open ${repoInfo.full_name} on GitHub`}
>
  <span
    class="text-meta ease group-hover:text-link mt-[2px] inline-flex h-5 w-5 shrink-0 items-center justify-center transition-colors duration-300"
  >
    <Icon name="octicon:mark-github-16" width="16" height="16" />
  </span>

  <div class="min-w-0 flex-1">
    <div class="flex min-w-0 flex-wrap items-center gap-x-2 gap-y-1">
      <span
        class="text-link ease group-hover:text-link-hover min-w-0 truncate font-medium transition-colors duration-300"
      >
        {repoInfo.full_name}
      </span>

      {
        (language || typeof stars === "number") && (
          <span class="text-small text-meta flex items-center gap-2">
            {language && <span>{language}</span>}
            {language && typeof stars === "number" && (
              <span aria-hidden="true">·</span>
            )}
            {typeof stars === "number" && (
              <span class="whitespace-nowrap">
                ★ {formatCompactNumber(stars)}
              </span>
            )}
          </span>
        )
      }
    </div>

    {
      repoInfo.description && (
        <p class="text-small text-secondary mt-1 line-clamp-1">
          {repoInfo.description}
        </p>
      )
    }
  </div>
</a>
